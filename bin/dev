#!/usr/bin/env bash

[ ! -z "$DEBUG" ] && set -x

DIR="$(cd "$(dirname "$0")" && pwd)"
DOTDIR="$HOME/.living-in-a-box"

if [[ "$OSTYPE" == darwin* ]]; then
  VAGRANT="vagrant"
  export FORWARD_DOCKER_PORTS=y
  export VAGRANT_DOTFILE_PATH="$DOTDIR/.vagrant"
  export VAGRANT_VAGRANTFILE="$DIR/../docker/Vagrantfile"
  export DOCKER_HOST=localhost
fi

port_arguments() {
  local ports=""
  for port in "$@"; do
    ports+="-p $port "
  done
  echo $ports
}

run_image() {
  local name=$1
  local ports=$(port_arguments "${@:2}")
  local id=$(docker run \
    -d \
    -volumes-from ${USER}_${name}_data \
    -name ${USER}_$name \
    $ports \
    gewo/$name)
  echo "Started $name in container $id"
}

create_data_container() {
  local name=$1
  docker ps -a | grep "${USER}_${name}_data" > /dev/null
  if [ $? != 0 ]; then
    docker run -v /data -v /logs -name ${USER}_${name}_data busybox true
  fi
}

start_image() {
  local name=$1
  create_data_container $name
  run_image $@
}

link_arguments() {
  local links=""
  for service in redis mongodb mysql; do
    links+="-link ${USER}_$service:$service "
  done
  echo $links
}

start_services() {
  start_image redis 6379
  start_image mongodb 27017 28017
  start_image mysql 3306
}

start_vagrant() {
  if [ ! -z "$VAGRANT" ]; then
    if ! $VAGRANT status | grep running; then
      $VAGRANT up
    fi
  fi
}

start() {
  start_vagrant
  start_services
}

stop() {
  local running=$(docker ps | tail -n +2 | grep ${USER} | awk '{ print $1 }')
  if [ "$running" != "" ]; then
    docker stop $running
    docker rm $running
  fi
}

kill_() {
  local containers=$(docker ps -a | tail -n +2 | grep -v "_data" | \
    grep ${USER} | awk '{ print $1 }')
  if [ "$containers" != "" ]; then
    docker stop $containers
    docker rm $containers
  fi
}

shell() {
  local links=$(link_arguments)
  local image="gewo/rails"
  local mnt="$PWD"

  [ -n "$PORT" ] && local port="${PORT}:"

  if [ ! -z "$VAGRANT" ]; then
    mnt="/vagrant"
  fi

  if [ "$1" != "" ]; then
    image="$1"
  fi

  local id=$(docker run \
    -d \
    -i -t \
    -v "$mnt":/mnt \
    -p ${port}3000 \
    $links \
    $image \
    /bin/bash)
  local port=$(docker port $id 3000)
  echo "port 3000 forwarded to ${port}"
  docker attach $id
  sleep 1 && docker rm $id >/dev/null
}

build_images() {
  $DIR/build_images
}

usage() {
  echo "$0 [start,stop,kill,shell,build_images,vagrant,docker]"
  exit 1
}

cmd="$1"
shift

case "$cmd" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  kill)
    kill_
    ;;
  shell)
    shell ${@}
    ;;
  build_images)
    build_images
    ;;
  vagrant)
    [ ! -z "$VAGRANT" ] && vagrant ${@}
    ;;
  docker)
    docker ${@}
    ;;
  *)
    usage
    ;;
esac
